#!/bin/bash
# Bundle install hook generated by Aircana
# This hook runs bundle install when Gemfile changes are detected

# Get the tool details
TOOL_NAME="$1"
TOOL_PARAMS="$2"

# Only act on file modification tools
case "$TOOL_NAME" in
  "Edit"|"Write"|"MultiEdit")
    ;;
  *)
    exit 0
    ;;
esac

# Check if Gemfile was modified
if ! echo "$TOOL_PARAMS" | grep -q "Gemfile"; then
  exit 0
fi

# Check if this is a Ruby project
if [ ! -f "Gemfile" ]; then
  exit 0
fi

echo "Gemfile modified, running bundle install..."

# Run bundle install
if command -v bundle >/dev/null 2>&1; then
  bundle install
  BUNDLE_EXIT_CODE=$?

  if [ $BUNDLE_EXIT_CODE -eq 0 ]; then
    cat << EOF
{
      "type": "advanced",
      "decision": "allow",
      "message": "Bundle install completed successfully after Gemfile modification."
    }
EOF
  else
    cat << EOF
{
      "type": "advanced",
      "decision": "allow",
      "message": "Bundle install failed. You may need to run 'bundle install' manually.\n\nError code: $BUNDLE_EXIT_CODE"
    }
EOF
  fi
else
  cat << EOF
{
    "type": "advanced",
    "decision": "allow",
    "message": "Bundler not found. Please install bundler and run 'bundle install' manually."
  }
EOF
fi

# Always allow the modification to proceed
exit 0