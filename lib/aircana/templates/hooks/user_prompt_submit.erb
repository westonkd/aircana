#!/bin/bash
# User prompt submit hook generated by Aircana
# This hook runs when the user submits a prompt

# Get the user prompt
USER_PROMPT="$1"

# Add context information based on project state
CONTEXT_ADDITIONS=""

# Check if this is a Ruby project and add relevant info
if [ -f "Gemfile" ]; then
  CONTEXT_ADDITIONS="${CONTEXT_ADDITIONS}\n\nProject Context: This is a Ruby project with Gemfile present."

  # Check for common Ruby frameworks
  if grep -q "rails" Gemfile 2>/dev/null; then
    CONTEXT_ADDITIONS="${CONTEXT_ADDITIONS} Rails framework detected."
  fi

  if grep -q "rspec" Gemfile 2>/dev/null; then
    CONTEXT_ADDITIONS="${CONTEXT_ADDITIONS} RSpec testing framework in use."
  fi
fi

# Check for relevant files context
if [ -d ".aircana/relevant_files" ] && [ "$(ls -A .aircana/relevant_files 2>/dev/null)" ]; then
  RELEVANT_COUNT=$(ls .aircana/relevant_files | wc -l)
  CONTEXT_ADDITIONS="${CONTEXT_ADDITIONS}\n\nRelevant Files: $RELEVANT_COUNT files currently in context."
fi

# Output JSON response with additional context
if [ -n "$CONTEXT_ADDITIONS" ]; then
  # Escape context for JSON
  ESCAPED_CONTEXT=$(echo -n "$CONTEXT_ADDITIONS" | sed 's/"/\\"/g' | tr '\n' ' ' | sed 's/  */ /g')
  cat << EOF
{
  "hookSpecificOutput": {
    "hookEventName": "UserPromptSubmit",
    "additionalContext": "$ESCAPED_CONTEXT"
  }
}
EOF
else
  # No additional context needed
  echo "{}"
fi